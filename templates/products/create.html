{% extends 'base.html' %}

{% block title %}{% if object %}Modifier{% else %}Nouveau{% endif %} Produit - {{ site_name }}{% endblock %}
{% block page_title %}{% if object %}Modifier le produit{% else %}Nouveau produit{% endif %}{% endblock %}
{% block page_subtitle %}{% if object %}Modifiez les informations du produit{% else %}Ajoutez un nouveau produit √† votre catalogue{% endif %}{% endblock %}

{% block content %}

<div class="max-w-5xl mx-auto">
    <!-- Breadcrumb -->
    <div class="mb-6">
        <nav class="flex items-center space-x-2 text-sm text-gray-500">
            <a href="{% url 'products:list' %}" class="hover:text-gray-700">Produits</a>
            <i class="fas fa-chevron-right text-xs"></i>
            <span class="text-gray-900">{% if object %}Modifier{% else %}Nouveau{% endif %}</span>
        </nav>
    </div>

    <form method="post" enctype="multipart/form-data" class="space-y-6" x-data="productForm()">
        {% csrf_token %}

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <!-- Main Form -->
            <div class="lg:col-span-2 space-y-6">

                <!-- Basic Information -->
                <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
                    <div class="bg-gradient-to-r from-primary-50 to-primary-100 px-6 py-4 border-b border-primary-200">
                        <h2 class="text-lg font-bold text-gray-900 flex items-center">
                            <div class="w-10 h-10 bg-primary-600 rounded-lg flex items-center justify-center mr-3">
                                <i class="fas fa-box text-white"></i>
                            </div>
                            Informations g√©n√©rales
                        </h2>
                    </div>

                    <div class="p-6 space-y-6">
                        <!-- Name -->
                        <div>
                            <label for="id_name" class="block text-sm font-medium text-gray-700 mb-2">
                                Nom du produit
                                <span class="text-red-500">*</span>
                            </label>
                            {{ form.name }}
                            {% if form.name.errors %}
                            <p class="mt-2 text-sm text-red-600">{{ form.name.errors.0 }}</p>
                            {% endif %}
                        </div>

                        <!-- SKU & Category -->
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <label for="id_sku" class="block text-sm font-medium text-gray-700 mb-2">
                                    SKU (Code produit)
                                    <span class="text-red-500">*</span>
                                </label>
                                <div class="relative">
                                    <div class="absolute inset-y-0 left-0 flex items-center pl-3 pointer-events-none">
                                        <i class="fas fa-barcode text-gray-400"></i>
                                    </div>
                                    <input type="text"
                                           name="sku"
                                           id="id_sku"
                                           value="{{ form.sku.value|default:'' }}"
                                           required
                                           class="block w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent font-mono">
                                </div>
                                {% if form.sku.errors %}
                                <p class="mt-2 text-sm text-red-600">{{ form.sku.errors.0 }}</p>
                                {% endif %}
                                <p class="mt-1 text-xs text-gray-500">Code unique pour identifier le produit</p>
                            </div>

                            <div>
                                <label for="id_category" class="block text-sm font-medium text-gray-700 mb-2">
                                    Cat√©gorie
                                </label>
                                {{ form.category }}
                                {% if form.category.errors %}
                                <p class="mt-2 text-sm text-red-600">{{ form.category.errors.0 }}</p>
                                {% endif %}
                            </div>
                        </div>

                        <!-- Reference -->
                        <div>
                            <label for="id_reference" class="block text-sm font-medium text-gray-700 mb-2">
                                R√©f√©rence fournisseur
                            </label>
                            {{ form.reference }}
                            {% if form.reference.errors %}
                            <p class="mt-2 text-sm text-red-600">{{ form.reference.errors.0 }}</p>
                            {% endif %}
                        </div>

                        <!-- Description -->
                        <div>
                            <label for="id_description" class="block text-sm font-medium text-gray-700 mb-2">
                                Description
                            </label>
                            {{ form.description }}
                            {% if form.description.errors %}
                            <p class="mt-2 text-sm text-red-600">{{ form.description.errors.0 }}</p>
                            {% endif %}
                            <p class="mt-1 text-xs text-gray-500">Description d√©taill√©e du produit</p>
                        </div>
                    </div>
                </div>

                <!-- Pricing -->
                <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
                    <div class="bg-gradient-to-r from-blue-50 to-blue-100 px-6 py-4 border-b border-blue-200">
                        <h2 class="text-lg font-bold text-gray-900 flex items-center">
                            <div class="w-10 h-10 bg-blue-600 rounded-lg flex items-center justify-center mr-3">
                                <i class="fas fa-euro-sign text-white"></i>
                            </div>
                            Tarification
                        </h2>
                    </div>

                    <div class="p-6 space-y-6">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <!-- Unit Price -->
                            <div>
                                <label for="id_unit_price" class="block text-sm font-medium text-gray-700 mb-2">
                                    Prix de vente HT
                                    <span class="text-red-500">*</span>
                                </label>
                                <div class="relative">
                                    <div class="absolute inset-y-0 left-0 flex items-center pl-3 pointer-events-none">
                                        <i class="fas fa-euro-sign text-gray-400"></i>
                                    </div>
                                    <input type="number"
                                           name="unit_price"
                                           id="id_unit_price"
                                           x-model="unitPrice"
                                           @input="calculateMargin"
                                           value="{{ form.unit_price.value|default:'' }}"
                                           step="0.01"
                                           min="0"
                                           required
                                           class="block w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent">
                                </div>
                                {% if form.unit_price.errors %}
                                <p class="mt-2 text-sm text-red-600">{{ form.unit_price.errors.0 }}</p>
                                {% endif %}
                            </div>

                            <!-- Cost Price -->
                            <div>
                                <label for="id_cost_price" class="block text-sm font-medium text-gray-700 mb-2">
                                    Prix d'achat HT
                                </label>
                                <div class="relative">
                                    <div class="absolute inset-y-0 left-0 flex items-center pl-3 pointer-events-none">
                                        <i class="fas fa-euro-sign text-gray-400"></i>
                                    </div>
                                    <input type="number"
                                           name="cost_price"
                                           id="id_cost_price"
                                           x-model="costPrice"
                                           @input="calculateMargin"
                                           value="{{ form.cost_price.value|default:'' }}"
                                           step="0.01"
                                           min="0"
                                           class="block w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent">
                                </div>
                                {% if form.cost_price.errors %}
                                <p class="mt-2 text-sm text-red-600">{{ form.cost_price.errors.0 }}</p>
                                {% endif %}
                            </div>
                        </div>

                        <!-- Tax Rate -->
                        <div>
                            <label for="id_tax_rate" class="block text-sm font-medium text-gray-700 mb-2">
                                Taux de TVA (%)
                                <span class="text-red-500">*</span>
                            </label>
                            <select name="tax_rate"
                                    id="id_tax_rate"
                                    class="block w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent">
                                <option value="0">0% - Exon√©r√©</option>
                                <option value="5.5">5.5% - Taux r√©duit</option>
                                <option value="10">10% - Taux interm√©diaire</option>
                                <option value="20" {% if not form.tax_rate.value or form.tax_rate.value == '20' %}selected{% endif %}>20% - Taux normal</option>
                            </select>
                            {% if form.tax_rate.errors %}
                            <p class="mt-2 text-sm text-red-600">{{ form.tax_rate.errors.0 }}</p>
                            {% endif %}
                        </div>

                        <!-- Margin Preview -->
                        <div x-show="margin !== null" class="p-4 bg-green-50 border border-green-200 rounded-lg">
                            <div class="flex items-center justify-between">
                                <span class="text-sm font-medium text-green-900">Marge calcul√©e</span>
                                <span class="text-lg font-bold text-green-600" x-text="margin + '%'"></span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Stock Management -->
                <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
                    <div class="bg-gradient-to-r from-green-50 to-green-100 px-6 py-4 border-b border-green-200">
                        <h2 class="text-lg font-bold text-gray-900 flex items-center">
                            <div class="w-10 h-10 bg-green-600 rounded-lg flex items-center justify-center mr-3">
                                <i class="fas fa-warehouse text-white"></i>
                            </div>
                            Gestion du stock
                        </h2>
                    </div>

                    <div class="p-6 space-y-6">
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                            <!-- Stock Quantity -->
                            <div>
                                <label for="id_quantity_in_stock" class="block text-sm font-medium text-gray-700 mb-2">
                                    Quantit√© en stock
                                    <span class="text-red-500">*</span>
                                </label>
                                <input type="number"
                                       name="quantity_in_stock"
                                       id="id_quantity_in_stock"
                                       value="{{ form.quantity_in_stock.value|default:0 }}"
                                       min="0"
                                       required
                                       class="block w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent">
                                {% if form.quantity_in_stock.errors %}
                                <p class="mt-2 text-sm text-red-600">{{ form.quantity_in_stock.errors.0 }}</p>
                                {% endif %}
                            </div>

                            <!-- Reorder Level -->
                            <div>
                                <label for="id_reorder_level" class="block text-sm font-medium text-gray-700 mb-2">
                                    Seuil d'alerte
                                </label>
                                <input type="number"
                                       name="reorder_level"
                                       id="id_reorder_level"
                                       value="{{ form.reorder_level.value|default:10 }}"
                                       min="0"
                                       class="block w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent">
                                {% if form.reorder_level.errors %}
                                <p class="mt-2 text-sm text-red-600">{{ form.reorder_level.errors.0 }}</p>
                                {% endif %}
                                <p class="mt-1 text-xs text-gray-500">Alerte de stock faible</p>
                            </div>

                            <!-- Unit -->
                            <div>
                                <label for="id_unit" class="block text-sm font-medium text-gray-700 mb-2">
                                    Unit√©
                                </label>
                                <select name="unit"
                                        id="id_unit"
                                        class="block w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent">
                                    <option value="pcs">Pi√®ces (pcs)</option>
                                    <option value="kg">Kilogrammes (kg)</option>
                                    <option value="l">Litres (l)</option>
                                    <option value="m">M√®tres (m)</option>
                                    <option value="h">Heures (h)</option>
                                </select>
                                {% if form.unit.errors %}
                                <p class="mt-2 text-sm text-red-600">{{ form.unit.errors.0 }}</p>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Sidebar -->
            <div class="lg:col-span-1 space-y-6">

                <!-- Product Image -->
                <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
                    <h3 class="text-sm font-semibold text-gray-900 mb-4">Image du produit</h3>

                    <div class="mb-4">
                        <div class="relative h-48 bg-gradient-to-br from-gray-100 to-gray-200 rounded-lg flex items-center justify-center overflow-hidden" x-data="imagePreview()">
                            <template x-if="!imageUrl">
                                <div class="text-center">
                                    <i class="fas fa-image text-gray-400 text-5xl mb-3"></i>
                                    <p class="text-sm text-gray-500">Aucune image</p>
                                </div>
                            </template>
                            <template x-if="imageUrl">
                                <img :src="imageUrl" alt="Preview" class="w-full h-full object-cover">
                            </template>
                        </div>
                    </div>

                    <input type="file"
                           name="image"
                           id="id_image"
                           accept="image/*"
                           @change="previewImage"
                           class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-semibold file:bg-primary-50 file:text-primary-700 hover:file:bg-primary-100">
                    {% if form.image.errors %}
                    <p class="mt-2 text-sm text-red-600">{{ form.image.errors.0 }}</p>
                    {% endif %}
                </div>

                <!-- Status -->
                <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
                    <h3 class="text-sm font-semibold text-gray-900 mb-4">Statut</h3>

                    <label class="relative inline-flex items-center cursor-pointer">
                        <input type="checkbox"
                               name="is_active"
                               id="id_is_active"
                               {% if not object or form.is_active.value %}checked{% endif %}
                               class="sr-only peer">
                        <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-primary-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-primary-600"></div>
                        <span class="ml-3 text-sm font-medium text-gray-900">Produit actif</span>
                    </label>
                    <p class="mt-2 text-xs text-gray-500">Les produits inactifs n'apparaissent pas dans les factures</p>
                </div>

                <!-- Quick Info -->
                <div class="bg-gradient-to-br from-blue-50 to-blue-100 rounded-xl border border-blue-200 p-6">
                    <h3 class="text-sm font-semibold text-gray-900 mb-3">üí° Conseils</h3>
                    <ul class="space-y-2 text-xs text-gray-700">
                        <li class="flex items-start">
                            <i class="fas fa-check text-blue-600 mt-0.5 mr-2"></i>
                            <span>Utilisez un SKU unique et facile √† identifier</span>
                        </li>
                        <li class="flex items-start">
                            <i class="fas fa-check text-blue-600 mt-0.5 mr-2"></i>
                            <span>Ajoutez une description d√©taill√©e pour vos clients</span>
                        </li>
                        <li class="flex items-start">
                            <i class="fas fa-check text-blue-600 mt-0.5 mr-2"></i>
                            <span>D√©finissez un seuil d'alerte adapt√©</span>
                        </li>
                        <li class="flex items-start">
                            <i class="fas fa-check text-blue-600 mt-0.5 mr-2"></i>
                            <span>Utilisez des images de bonne qualit√©</span>
                        </li>
                    </ul>
                </div>
            </div>
        </div>

        <!-- Action Buttons -->
        <div class="flex items-center justify-between pt-6 border-t border-gray-200">
            <a href="{% url 'products:list' %}"
               class="inline-flex items-center px-6 py-3 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-lg hover:bg-gray-50 shadow-sm">
                <i class="fas fa-times mr-2"></i>
                Annuler
            </a>

            <div class="flex items-center space-x-3">
                {% if object %}
                <button type="button"
                        onclick="window.location.href='{% url 'products:detail' object.pk %}'"
                        class="inline-flex items-center px-6 py-3 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-lg hover:bg-gray-50 shadow-sm">
                    <i class="fas fa-eye mr-2"></i>
                    Aper√ßu
                </button>
                {% endif %}

                <button type="submit"
                        class="inline-flex items-center px-6 py-3 text-sm font-medium text-white bg-gradient-to-r from-primary-600 to-primary-700 rounded-lg hover:from-primary-700 hover:to-primary-800 shadow-lg hover:shadow-xl transition-all">
                    <i class="fas fa-save mr-2"></i>
                    {% if object %}Mettre √† jour{% else %}Cr√©er le produit{% endif %}
                </button>
            </div>
        </div>
    </form>
</div>

{% endblock %}

{% block extra_js %}
<script>
function productForm() {
    return {
        unitPrice: {{ form.unit_price.value|default:0 }},
        costPrice: {{ form.cost_price.value|default:0 }},
        margin: null,

        calculateMargin() {
            if (this.unitPrice > 0 && this.costPrice > 0) {
                this.margin = (((this.unitPrice - this.costPrice) / this.costPrice) * 100).toFixed(2);
            } else {
                this.margin = null;
            }
        },

        init() {
            this.calculateMargin();
        }
    }
}

function imagePreview() {
    return {
        imageUrl: '{% if object.image %}{{ object.image.url }}{% endif %}',

        previewImage(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    this.imageUrl = e.target.result;
                };
                reader.readAsDataURL(file);
            }
        }
    }
}
</script>
{% endblock %}
